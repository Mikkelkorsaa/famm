@inject IAbstractService AbstractService
@inject IConferenceService ConferenceService
@inject IUserService UserService
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<EditForm Model="Review" OnValidSubmit="UpdateReview">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="abstract-review-wrapper">
        <div class="abstract-review">
            <div class="review-card">
                <div class="review-criteria">
                    @foreach (var criteria in Review.Criterias)
                    {
                        <div class="form-group">
                            <label class="criteria-label">@criteria.Name</label>
                            <div class="grade-selector">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    int gradeValue = i;
                                    <button type="button"
                                    class="grade-button @(criteria.Grade == gradeValue ? "selected" : "")"
                                    @onclick="() => SetCriteriaGrade(criteria.Name, gradeValue)">
                                        @gradeValue
                                    </button>
                                }
                            </div>
                        </div>
                    }

                    <div class="form-group">
                        <label class="comment-label">Comment</label>
                        <textarea class="comment-textarea"
                        rows="4"
                        @bind="_comment"
                        placeholder="Enter your detailed observations...">@_comment</textarea>
                    </div>

                    <div class="form-group">
                        <input type="checkbox" id="recommendCheckbox" @bind="recommend" />
                        <label for="recommendCheckbox" class="recommend-label">Recommend Abstract</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="button-container">
            <button type="submit"
            class="save-button"
            disabled="@(isSaving)">
                @if (isSaving)
                {
                    <span class="spinner"></span>
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save Review</span>
                }
            </button>
        </div>
    </div>
</EditForm>

<style>
    .abstract-review-header {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    text-align: center;
    }

    .review-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    }

    .reviews-grid {
    display: grid;
    gap: 1rem;
    }

    .review-card {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    }

    .grade-selector {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    }

    .grade-button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #3b82f6;
    background-color: transparent;
    color: #3b82f6;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    }

    .grade-button.selected {
    background-color: #3b82f6;
    color: white;
    }

    .grade-button:hover {
    background-color: #3b82f6;
    color: white;
    }

    .comment-textarea {
    width: 100%;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.75rem;
    resize: vertical;
    transition: border-color 0.3s ease;
    }

    .comment-textarea:focus {
    border-color: #3b82f6;
    outline: none;
    }

    .button-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 1.5rem;
    }

    .save-button {
    background-color: #3b82f6;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    }

    .save-button:hover:not(:disabled) {
    background-color: #2563eb;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .save-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    }

    .no-reviews-placeholder {
    text-align: center;
    color: #6b7280;
    padding: 2rem;
    }

    .no-reviews-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #9ca3af;
    }

    .recommend-label {
    margin-left: 0.5rem;
    font-size: 1rem;
    color: #374151;
    }

    input[type="checkbox"] {
    width: 20px;
    height: 20px;
    border: 2px solid #3b82f6;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    }

    input[type="checkbox"]:checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
    }
</style>

@code {
    [Parameter]
    public Abstract? SelectedAbstract { get; set; }
    private int? UserId;
    private bool isSaving = false;
    private List<string> reviewCriteria = new();
    private int newReviewId;
    private bool recommend = false;
    private string _comment = "";
    private Review Review = new();
    private bool _hasReviewed = false;

    protected override async Task OnInitializedAsync()
    {
        int? conferenceId = await LocalStorage.GetItemAsync<int?>("currentConferenceId");

        try
        {
            UserId = await UserService.GetCurrentUserIdAsync();
        }
        catch (InvalidOperationException)
        {
            // Handle the error appropriately, e.g., redirect to login or show an error message
            return;
        }

        if (SelectedAbstract != null && UserId.HasValue) //if the person hasnt reviewed
        {
            _hasReviewed = await ConferenceService.HasReviewAsync(SelectedAbstract.Id, UserId.Value);
            if (!_hasReviewed)
            {
                newReviewId = await ConferenceService.GetNextReviewIdAsync(SelectedAbstract.Id);
                reviewCriteria = await ConferenceService.GetCriteriaByIdAsync(conferenceId.Value);

                Review = new Review
                    {
                        Id = newReviewId,
                        UserId = UserId ?? 0,
                        Criterias = reviewCriteria.Select(c => new Criteria { Name = c }).ToList()
                    };
                Console.WriteLine("Der findes ikke et review");
                Console.WriteLine(Review);

            }
            else 
            {
                var existingReview = await ConferenceService.GetExistingReviewAsync(SelectedAbstract.Id, UserId.Value);
                if (existingReview != null)
                {
                    Review = existingReview;
                    Console.WriteLine("Der findes et review");
                    Console.WriteLine(Review);
                    _comment = Review.Comment ?? string.Empty;
                }
            }
        }
        

       
    }

    private async Task UpdateReview()
    {
        if (SelectedAbstract == null)
        {
            return;
        }

        isSaving = true;
        try
        {
            
            
            Review.Recommend = recommend; // Ensure Recommend is set
            Review.Comment = _comment;
           
            Console.WriteLine(Review);
            await ConferenceService.UpdateReview(SelectedAbstract.Id, Review);
            Console.WriteLine(Review);
            // Optionally, display a success toast or notification
        }
        catch (Exception)
        {
            // Optionally, display an error notification
        }
        finally
        {
            isSaving = false;
        }
    }

    private void SetCriteriaGrade(string criteriaName, int gradeValue)
    {
        var criteria = Review.Criterias.FirstOrDefault(c => c.Name == criteriaName);
        if (criteria != null)
        {
            criteria.Grade = gradeValue;
        }
        else
        {
            Review.Criterias.Add(new Criteria { Name = criteriaName, Grade = gradeValue });
        }
    }
}

